<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BliKins Messenger</title>
    <style>
        :root {
            --bg-color: #0e1621;
            --sidebar-bg: #17212b;
            --text-color: #ffffff;
            --accent-color: #2b5278;
            --input-bg: #242f3d;
            --msg-out: #2b5278;
        }

        body {
            margin: 0; font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden;
        }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è */
        .auth-container {
            background: var(--sidebar-bg); padding: 30px; border-radius: 15px;
            text-align: center; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        input {
            width: 100%; margin: 8px 0; padding: 12px; box-sizing: border-box;
            background: var(--input-bg); border: 1px solid #303030; color: white; border-radius: 8px;
        }

        button {
            width: 100%; padding: 12px; background: var(--accent-color);
            border: none; color: white; cursor: pointer; border-radius: 8px; font-weight: bold; margin-top: 10px;
        }

        /* –û—Å–Ω–æ–≤–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ */
        #messenger-app { display: none; width: 100%; height: 100vh; flex-direction: row; }

        .sidebar { width: 350px; background: var(--sidebar-bg); border-right: 1px solid #0e1621; display: flex; flex-direction: column; }
        
        .sidebar-header { padding: 15px; display: flex; align-items: center; gap: 10px; }
        
        #search-results { background: #242f3d; max-height: 200px; overflow-y: auto; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #17212b; }
        .search-item:hover { background: #2b5278; }

        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item { padding: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #0e1621; }
        .chat-item:hover { background: #242f3d; }
        .chat-item img { border-radius: 50%; }

        .chat-window { flex-grow: 1; display: flex; flex-direction: column; background: #0e1621; }
        .chat-header { padding: 15px; background: var(--sidebar-bg); display: flex; align-items: center; gap: 10px; font-weight: bold; }
        
        #messages-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .input-area { padding: 15px; background: var(--sidebar-bg); display: flex; gap: 10px; }

        /* –ë–æ–∫–æ–≤–µ –º–µ–Ω—é */
        #side-menu {
            position: fixed; left: -300px; top: 0; width: 280px; height: 100%;
            background: var(--sidebar-bg); transition: 0.3s; z-index: 100; padding: 20px;
        }
        #side-menu.active { left: 0; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="auth-screen" class="auth-container">
        <h2 id="auth-title">BliKins –í—Ö—ñ–¥</h2>
        <input type="text" id="auth-user" placeholder="–õ–æ–≥—ñ–Ω">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        
        <div id="reg-fields" class="hidden">
            <input type="password" id="auth-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
            <input type="text" id="auth-secret" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–æ–¥">
        </div>

        <button onclick="handleAuth()" id="auth-btn">–£–≤—ñ–π—Ç–∏</button>
        <p style="font-size: 13px; cursor: pointer; margin-top: 15px;" onclick="toggleAuth()">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</p>
    </div>

    <div id="messenger-app">
        <div id="side-menu">
            <img id="my-ava" src="https://via.placeholder.com/60" style="border-radius: 50%;">
            <h3 id="my-name">–õ–æ–≥—ñ–Ω</h3>
            <p>Pepe Coins: <span id="my-coins">0</span> üê∏</p>
            <hr>
            <button onclick="alert('–ü—Ä–æ—Ñ—ñ–ª—å')">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</button>
            <button id="adm-btn" class="hidden" style="background: #a32a2a;">üõ°Ô∏è –ê–¥–º—ñ–Ω –ü–∞–Ω–µ–ª—å</button>
            <button onclick="location.reload()" style="margin-top: 50px; background: #444;">–í–∏–π—Ç–∏</button>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <span style="cursor:pointer; font-size: 20px;" onclick="document.getElementById('side-menu').classList.toggle('active')">‚ò∞</span>
                <input type="text" id="user-search" placeholder="–ü–æ—à—É–∫ –ª—é–¥–µ–π..." oninput="searchUsers()">
            </div>
            <div id="search-results"></div>
            <div class="chat-list" id="contacts">
                <div class="chat-item">
                    <img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" width="45">
                    <div><strong>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ ‚úÖ</strong><p style="margin:0; font-size: 12px; color: gray;">–ß–∏–º –¥–æ–ø–æ–º–æ–≥—Ç–∏?</p></div>
                </div>
            </div>
        </div>

        <div class="chat-window">
            <div class="chat-header">
                <img id="chat-with-ava" src="https://via.placeholder.com/40" style="border-radius: 50%;">
                <span id="chat-with-name">–í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Ç</span>
            </div>
            <div id="messages-container"></div>
            <div class="input-area">
                <button style="width: 50px;">üìé</button>
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —â–æ—Å—å...">
                <button style="width: 100px;" onclick="alert('–ß–∞—Ç –±—É–¥–µ —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ!')">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, query, orderByChild, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBV3cEHIGsVyCSeNy1eo4ZBj7vhL0f0nHA",
            authDomain: "blikins-23ca8.firebaseapp.com",
            databaseURL: "https://blikins-23ca8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "blikins-23ca8",
            storageBucket: "blikins-23ca8.firebasestorage.app",
            messagingSenderId: "907805919084",
            appId: "1:907805919084:web:714e2d2b63d738e86c9549"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let isReg = false;

        window.toggleAuth = () => {
            isReg = !isReg;
            document.getElementById('reg-fields').classList.toggle('hidden');
            document.getElementById('auth-title').innerText = isReg ? 'BliKins –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è' : 'BliKins –í—Ö—ñ–¥';
            document.getElementById('auth-btn').innerText = isReg ? '–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è' : '–£–≤—ñ–π—Ç–∏';
        };

        window.handleAuth = async () => {
            const user = document.getElementById('auth-user').value;
            const pass = document.getElementById('auth-pass').value;
            const email = user + "@blikins.com";

            if (isReg) {
                const conf = document.getElementById('auth-confirm').value;
                const sec = document.getElementById('auth-secret').value;
                
                if (pass !== conf) return alert("–ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è!");
                
                let role = "";
                if (sec === "232348") role = "user";
                else if (sec === "*?‚Ññ3827428") role = "admin";
                else return alert("–ù–µ–≤—ñ—Ä–Ω–∏–π —Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–æ–¥!");

                try {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await set(ref(db, 'users/' + res.user.uid), {
                        username: user,
                        role: role,
                        pepeCoins: 0,
                        avatar: "https://via.placeholder.com/60"
                    });
                    alert("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.");
                    location.reload();
                } catch (e) { alert(e.message); }
            } else {
                try {
                    const res = await signInWithEmailAndPassword(auth, email, pass);
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('messenger-app').style.display = 'flex';
                    loadMyData(res.user.uid);
                } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ."); }
            }
        };

        async function loadMyData(uid) {
            const snap = await get(ref(db, 'users/' + uid));
            const data = snap.val();
            document.getElementById('my-name').innerText = data.username;
            document.getElementById('my-coins').innerText = data.pepeCoins;
            if (data.role === "admin") document.getElementById('adm-btn').classList.remove('hidden');
        }

        window.searchUsers = async () => {
            const text = document.getElementById('user-search').value;
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = "";
            if (text.length < 2) return;

            const userRef = ref(db, 'users');
            const snap = await get(userRef);
            snap.forEach(child => {
                const u = child.val();
                if (u.username.toLowerCase().includes(text.toLowerCase())) {
                    const div = document.createElement('div');
                    div.className = "search-item";
                    div.innerText = u.username;
                    div.onclick = () => {
                        document.getElementById('chat-with-name').innerText = u.username;
                        resDiv.innerHTML = "";
                    };
                    resDiv.appendChild(div);
                }
            });
        };
    </script>
</body>
</html>
