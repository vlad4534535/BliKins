<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BliKins Messenger</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π BliKins */
            --secondary: #00b894; /* –ó–µ–ª–µ–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç */
            --bg-dark: #1e1e2e;
            --bg-panel: #2d2d44;
            --text-main: #ffffff;
            --text-muted: #a0a0b0;
            --danger: #ff7675;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: linear-gradient(135deg, #1e1e2e 0%, #4834d4 100%);
        }
        .auth-box {
            background: var(--bg-panel);
            padding: 30px;
            border-radius: 20px;
            width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
        }
        .auth-box input {
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 10px;
            border: none;
            background: #181825;
            color: white;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            width: 100%;
        }
        .btn:hover { opacity: 0.9; }
        .link { color: var(--secondary); cursor: pointer; font-size: 0.9em; margin-top: 10px; display: block; }

        /* --- MAIN APP --- */
        #app-screen { display: none; height: 100%; width: 100%; position: relative; }
        
        /* SIDEBAR (Profile/Settings) */
        #sidebar {
            position: absolute;
            left: -300px;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-panel);
            z-index: 100;
            transition: 0.3s;
            padding: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        #sidebar.open { left: 0; }
        .user-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 20px; }
        .user-avatar-lg { width: 80px; height: 80px; border-radius: 50%; background: var(--secondary); margin: 0 auto 10px; object-fit: cover;}
        .pepe-coins { color: gold; font-weight: bold; margin-top: 5px; }
        .sidebar-btn { padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-radius: 8px; }
        .sidebar-btn:hover { background: rgba(255,255,255,0.1); }
        .sidebar-btn.logout { margin-top: auto; color: var(--danger); }

        /* MAIN LAYOUT */
        .main-container { display: flex; width: 100%; height: 100%; }
        
        /* LEFT LIST (Chats) */
        .chat-list-panel {
            width: 350px;
            background: #252538;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        .header-bar {
            padding: 15px;
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-bar {
            flex: 1;
            background: #181825;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
        }
        .chat-item {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }
        .chat-item:hover { background: #2d2d44; }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: gray; object-fit: cover; }
        .official-badge { color: #00b894; margin-left: 5px; }

        /* RIGHT PANEL (Chat) */
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: url('https://www.transparenttextures.com/patterns/cubes.png'), var(--bg-dark); /* –§–æ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω */
        }
        .chat-header {
            padding: 15px;
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #333;
        }
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            position: relative;
        }
        .msg.mine { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 2px; }
        .msg.theirs { align-self: flex-start; background: #3b3b55; border-bottom-left-radius: 2px; }
        .msg-input-area {
            padding: 15px;
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-msg { flex: 1; padding: 12px; border-radius: 20px; border: none; background: #181825; color: white; }

        /* MODALS */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--bg-panel);
            padding: 25px;
            border-radius: 15px;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close-modal { float: right; cursor: pointer; font-size: 1.2em; }
        
        /* ADMIN PANEL SPECIFICS */
        .admin-user-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: #1e1e2e; margin-bottom: 5px; border-radius: 5px;
        }
        .admin-actions { display: flex; gap: 5px; }
        .icon-btn { cursor: pointer; padding: 5px; color: var(--text-muted); }
        .icon-btn:hover { color: var(--text-main); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box" id="login-form">
            <h2>–í—Ö–æ–¥ –≤ BliKins</h2>
            <input type="text" id="login-email" placeholder="–õ–æ–≥–∏–Ω (Email)">
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
            <span class="link" onclick="toggleAuth('register')">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
        </div>

        <div class="auth-box" id="register-form" style="display: none;">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="text" id="reg-login" placeholder="–õ–æ–≥–∏–Ω (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)">
            <input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" id="reg-pass-conf" placeholder="–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è">
            <input type="text" id="reg-secret" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥">
            <button class="btn" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <span class="link" onclick="toggleAuth('login')">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</span>
        </div>
    </div>

    <div id="app-screen">
        <div id="sidebar">
            <div class="user-header">
                <img src="" id="side-avatar" class="user-avatar-lg">
                <h3 id="side-username">User</h3>
                <div class="pepe-coins"><i class="fas fa-coins"></i> <span id="coin-balance">0</span> Pepe</div>
            </div>
            <div class="sidebar-btn" onclick="openProfile()"><i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å</div>
            <div class="sidebar-btn" onclick="openSettings()"><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="sidebar-btn" id="admin-btn" style="display:none;" onclick="openAdminPanel()"><i class="fas fa-shield-alt"></i> –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
            <div class="sidebar-btn logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏</div>
        </div>

        <div class="main-container">
            <div class="chat-list-panel">
                <div class="header-bar">
                    <i class="fas fa-bars icon-btn" onclick="toggleSidebar()"></i>
                    <input type="text" class="search-bar" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π/–∫–∞–Ω–∞–ª–æ–≤..." id="search-input" oninput="searchUsers(this.value)">
                    <i class="fas fa-pen icon-btn" onclick="openCreateMenu()"></i>
                </div>
                <div id="chats-container">
                    </div>
            </div>

            <div class="chat-window">
                <div class="chat-header" id="active-chat-header" style="display:none;">
                    <img src="" id="chat-header-avatar" class="chat-avatar">
                    <div style="flex:1;">
                        <h4 style="margin:0;" id="chat-header-name">Name</h4>
                        <small style="color:var(--text-muted);" id="chat-header-status">online</small>
                    </div>
                    <i class="fas fa-ellipsis-v icon-btn"></i>
                </div>
                
                <div class="messages-area" id="messages-area">
                    <div style="text-align:center; margin-top:50px; color: gray;">
                        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ BliKins</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –¥—Ä—É–≥–∞</p>
                    </div>
                </div>

                <div class="msg-input-area" id="input-area" style="display:none;">
                    <i class="fas fa-paperclip icon-btn"></i>
                    <input type="text" class="input-msg" id="message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <i class="far fa-smile icon-btn"></i>
                    <i class="fas fa-paper-plane icon-btn" onclick="sendMessage()" style="color:var(--secondary)"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="create-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('create-modal')">&times;</span>
            <h3>–°–æ–∑–¥–∞—Ç—å</h3>
            <button class="btn" style="margin-bottom:10px; background:#e17055;" onclick="createChat('group')">–ì—Ä—É–ø–ø—É</button>
            <button class="btn" onclick="createChat('channel')">–ö–∞–Ω–∞–ª</button>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <span class="close-modal" onclick="closeModal('admin-modal')">&times;</span>
            <h3>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
            <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="total-users">0</span></p>
            <div id="admin-users-list" style="margin-top:20px;">
                </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('profile-modal')">&times;</span>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <p>–õ–æ–≥–∏–Ω: <span id="edit-login" style="color:gray;"></span></p>
            <input type="text" id="edit-name" placeholder="–ò–º—è">
            <input type="text" id="edit-bio" placeholder="–û–ø–∏—Å–∞–Ω–∏—è">
            <input type="text" id="edit-avatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (URL)">
            <button class="btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, update, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBV3cEHIGsVyCSeNy1eo4ZBj7vhL0f0nHA",
            authDomain: "blikins-23ca8.firebaseapp.com",
            databaseURL: "https://blikins-23ca8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "blikins-23ca8",
            storageBucket: "blikins-23ca8.firebasestorage.app",
            messagingSenderId: "907805919084",
            appId: "1:907805919084:web:714e2d2b63d738e86c9549",
            measurementId: "G-739Q6G63Z1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUser = null;
        let currentChatId = null;

        // --- AUTH FUNCTIONS ---
        window.toggleAuth = (screen) => {
            document.getElementById('login-form').style.display = screen === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = screen === 'register' ? 'block' : 'none';
        }

        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º "—Ñ–µ–π–∫–æ–≤—ã–π" email –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, —Ç–∞–∫ –∫–∞–∫ Firebase Auth —Ç—Ä–µ–±—É–µ—Ç email
        // –ù–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏–Ω
        function makeEmail(login) { return login.toLowerCase() + "@blikins.app"; }

        window.register = async () => {
            const login = document.getElementById('reg-login').value;
            const p1 = document.getElementById('reg-pass').value;
            const p2 = document.getElementById('reg-pass-conf').value;
            const secret = document.getElementById('reg-secret').value;

            if(p1 !== p2) return alert("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!");
            if(!login || !p1) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");

            let role = 'user';
            if(secret === '232348') role = 'user';
            else if(secret === '*?‚Ññ3827428') role = 'admin';
            else return alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å! –ë–µ–∑ –Ω–µ–≥–æ –Ω–µ–ª—å–∑—è.");

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ –ª–æ–≥–∏–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ DB)
            const snapshot = await get(child(ref(db), `usernames/${login}`));
            if(snapshot.exists()) return alert("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç!");

            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userId = 'user_' + Date.now(); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
            const userData = {
                login: login,
                password: p1, // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Ö–µ—à–∏—Ä–æ–≤–∞—Ç—å!
                role: role,
                name: login, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–º—è = –ª–æ–≥–∏–Ω
                avatar: "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                pepeCoins: 0,
                bio: "–Ø –∏—Å–ø–æ–ª—å–∑—É—é BliKins",
                isPremium: false,
                isVerified: false,
                groups: []
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
            await set(ref(db, 'users/' + userId), userData);
            await set(ref(db, 'usernames/' + login), userId);

            // –°–æ–∑–¥–∞–µ–º —á–∞—Ç —Å –æ—Ñ—Ñ –±–æ—Ç–æ–º
            await createSupportChat(userId);

            alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
            window.toggleAuth('login');
        }

        window.login = async () => {
            const login = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;

            // –ò—â–µ–º user ID –ø–æ –ª–æ–≥–∏–Ω—É
            const snap = await get(child(ref(db), `usernames/${login}`));
            if(!snap.exists()) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
            const userId = snap.val();

            const userSnap = await get(ref(db, `users/${userId}`));
            const user = userSnap.val();

            if(user.password !== pass) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");

            // –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω
            currentUser = { ...user, uid: userId };
            localStorage.setItem('blikins_user', JSON.stringify(currentUser));
            loadApp();
        }

        window.logout = () => {
            if(confirm("–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) {
                localStorage.removeItem('blikins_user');
                location.reload();
            }
        }

        // --- APP LOGIC ---
        function loadApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            // Setup Sidebar Info
            document.getElementById('side-avatar').src = currentUser.avatar;
            document.getElementById('side-username').innerText = currentUser.name;
            document.getElementById('coin-balance').innerText = currentUser.pepeCoins;
            if(currentUser.role === 'admin') document.getElementById('admin-btn').style.display = 'flex';

            loadChats();
        }

        // --- CHATS & MESSAGES ---
        async function createSupportChat(userId) {
            const chatId = push(ref(db, 'chats')).key;
            await set(ref(db, `chats/${chatId}`), {
                type: 'private',
                participants: { [userId]: true, 'support_bot': true },
                lastMessage: "–ü—Ä–∏–≤–µ—Ç! –Ø –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç BliKins."
            });
            // Link chat to user
            await update(ref(db, `users/${userId}/chats/${chatId}`), { active: true });
        }

        function loadChats() {
            const chatsRef = ref(db, `users/${currentUser.uid}/chats`);
            onValue(chatsRef, (snapshot) => {
                const container = document.getElementById('chats-container');
                container.innerHTML = '';
                const chats = snapshot.val();
                if(!chats) return;

                Object.keys(chats).forEach(async (chatId) => {
                    const chatSnap = await get(ref(db, `chats/${chatId}`));
                    const chatData = chatSnap.val();
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∞–≤—É —á–∞—Ç–∞
                    let name = "–ß–∞—Ç", ava = "";
                    let verified = false;

                    if(chatData.type === 'private') {
                        // –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                        const otherId = Object.keys(chatData.participants).find(id => id !== currentUser.uid);
                        if(otherId === 'support_bot') {
                            name = "BliKins Support";
                            ava = "https://cdn-icons-png.flaticon.com/512/4712/4712035.png";
                            verified = true;
                        } else {
                            const uSnap = await get(ref(db, `users/${otherId}`));
                            const u = uSnap.val();
                            name = u.name;
                            ava = u.avatar;
                        }
                    } else {
                        name = chatData.name;
                        ava = chatData.avatar || "https://cdn-icons-png.flaticon.com/512/166/166258.png";
                    }

                    const div = document.createElement('div');
                    div.className = 'chat-item';
                    div.innerHTML = `
                        <img src="${ava}" class="chat-avatar">
                        <div>
                            <div style="font-weight:bold;">${name} ${verified ? '<i class="fas fa-check-circle official-badge"></i>' : ''}</div>
                            <div style="font-size:12px; color:#aaa;">${chatData.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                        </div>
                    `;
                    div.onclick = () => openChat(chatId, name, ava, chatData.type, chatData.owner);
                    container.appendChild(div);
                });
            });
        }

        window.openChat = (chatId, name, ava, type, owner) => {
            currentChatId = chatId;
            document.getElementById('active-chat-header').style.display = 'flex';
            document.getElementById('chat-header-name').innerText = name;
            document.getElementById('chat-header-avatar').src = ava;
            
            const inputArea = document.getElementById('input-area');
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
            if(type === 'channel' && owner !== currentUser.uid) {
                inputArea.style.display = 'none'; // –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç
            } else {
                inputArea.style.display = 'flex';
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            const msgsRef = ref(db, `chats/${chatId}/messages`);
            onValue(msgsRef, (snapshot) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                const msgs = snapshot.val();
                if(msgs) {
                    Object.values(msgs).forEach(m => {
                        const div = document.createElement('div');
                        div.className = `msg ${m.senderId === currentUser.uid ? 'mine' : 'theirs'}`;
                        div.innerText = m.text;
                        area.appendChild(div);
                    });
                    area.scrollTop = area.scrollHeight;
                }
            });
        }

        window.sendMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value;
            if(!text || !currentChatId) return;

            await push(ref(db, `chats/${currentChatId}/messages`), {
                text: text,
                senderId: currentUser.uid,
                timestamp: Date.now()
            });
            await update(ref(db, `chats/${currentChatId}`), { lastMessage: text });
            input.value = '';
        }

        // --- SEARCH ---
        window.searchUsers = async (val) => {
            if(val.length < 3) return; // –≠–∫–æ–Ω–æ–º–∏–º –∑–∞–ø—Ä–æ—Å—ã
            const container = document.getElementById('chats-container');
            container.innerHTML = '<div style="padding:10px;">–ü–æ–∏—Å–∫...</div>';

            // –ò—â–µ–º —Å—Ä–µ–¥–∏ –ª–æ–≥–∏–Ω–æ–≤
            const snap = await get(child(ref(db), `usernames/${val}`));
            if(snap.exists()) {
                const uid = snap.val();
                if(uid === currentUser.uid) return;
                
                const userSnap = await get(ref(db, `users/${uid}`));
                const user = userSnap.val();
                
                container.innerHTML = `
                    <div class="chat-item" onclick="startPrivateChat('${uid}')">
                        <img src="${user.avatar}" class="chat-avatar">
                        <div>${user.name} (@${user.login})</div>
                    </div>
                `;
            } else {
                container.innerHTML = '<div style="padding:10px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            }
        }

        window.startPrivateChat = async (targetId) => {
            // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç. 
            // –í –∏–¥–µ–∞–ª–µ –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —É–∂–µ —á–∞—Ç —Å —ç—Ç–∏–º —é–∑–µ—Ä–æ–º.
            const newChatId = push(ref(db, 'chats')).key;
            await set(ref(db, `chats/${newChatId}`), {
                type: 'private',
                participants: { [currentUser.uid]: true, [targetId]: true },
                lastMessage: "–ß–∞—Ç —Å–æ–∑–¥–∞–Ω"
            });
            await update(ref(db, `users/${currentUser.uid}/chats/${newChatId}`), { active: true });
            await update(ref(db, `users/${targetId}/chats/${newChatId}`), { active: true });
            loadChats(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫
        }

        // --- ADMIN PANEL ---
        window.openAdminPanel = async () => {
            document.getElementById('admin-modal').style.display = 'flex';
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤ (–û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ!)
            const snap = await get(ref(db, 'users'));
            const users = snap.val();
            const list = document.getElementById('admin-users-list');
            list.innerHTML = '';
            document.getElementById('total-users').innerText = Object.keys(users).length;

            Object.entries(users).forEach(([uid, u]) => {
                const row = document.createElement('div');
                row.className = 'admin-user-row';
                row.innerHTML = `
                    <div>
                        <strong>${u.login}</strong> (${u.pepeCoins} Pepe)
                        ${u.isVerified ? '‚úÖ' : ''} ${u.isPremium ? 'üåü' : ''}
                    </div>
                    <div class="admin-actions">
                        <button class="icon-btn" onclick="admAction('${uid}', 'msg')">‚úâÔ∏è</button>
                        <button class="icon-btn" onclick="admAction('${uid}', 'mute')">üîá</button>
                        <button class="icon-btn" onclick="admAction('${uid}', 'prem')">üåü</button>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        window.admAction = async (uid, action) => {
            if(action === 'prem') {
                await update(ref(db, `users/${uid}`), { isPremium: true });
                alert("–ü—Ä–µ–º–∏—É–º –≤—ã–¥–∞–Ω!");
            }
            if(action === 'mute') {
                // –õ–æ–≥–∏–∫–∞ –º—É—Ç–∞ —Å–ª–æ–∂–Ω–∞—è, –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—Ç–∏–º –≤ –±–∞–∑–µ
                await update(ref(db, `users/${uid}`), { isMuted: true });
                alert("–ú—É—Ç –≤—ã–¥–∞–Ω!");
            }
            if(action === 'msg') {
                // –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –æ—Ç –∏–º–µ–Ω–∏ –±–æ—Ç–∞ (—Å–∏–º—É–ª—è—Ü–∏—è)
                alert("–û—Ç–∫—Ä—ã–≤–∞—é —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º...");
                // –¢—É—Ç –Ω—É–∂–Ω–æ –ª–æ–≥–∏–∫—É –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
            }
            openAdminPanel(); // Refresh
        }

        // --- UI UTILS ---
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
        window.openCreateMenu = () => document.getElementById('create-modal').style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        
        window.openProfile = () => {
            document.getElementById('profile-modal').style.display = 'flex';
            document.getElementById('edit-login').innerText = currentUser.login;
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-bio').value = currentUser.bio;
            document.getElementById('edit-avatar').value = currentUser.avatar;
        }

        window.saveProfile = async () => {
            const newName = document.getElementById('edit-name').value;
            const newBio = document.getElementById('edit-bio').value;
            const newAva = document.getElementById('edit-avatar').value;

            await update(ref(db, `users/${currentUser.uid}`), {
                name: newName, bio: newBio, avatar: newAva
            });
            currentUser.name = newName; currentUser.bio = newBio; currentUser.avatar = newAva;
            closeModal('profile-modal');
            loadApp(); // Refresh UI
        }
        
        // Settings placeholder
        window.openSettings = () => alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏: –Ø–∑—ã–∫ (Eng/Rus/Ukr/Spa/Ger) - –¢–µ–º–∞. (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)");

        // Check if already logged in
        const stored = localStorage.getItem('blikins_user');
        if(stored) {
            currentUser = JSON.parse(stored);
            loadApp();
        }
    </script>
</body>
</html>
