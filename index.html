<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BliKins Messenger</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7; --secondary: #00b894; --bg-dark: #1e1e2e;
            --bg-panel: #2d2d44; --text-main: #ffffff; --text-muted: #a0a0b0;
            --danger: #ff7675; --accent: #fdcb6e;
        }
        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        body.light-theme {
            --bg-dark: #f0f2f5; --bg-panel: #ffffff; --text-main: #1c1e21;
            --text-muted: #65676b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; font-family: -apple-system, sans-serif;
            background-color: var(--bg-dark); color: var(--text-main);
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            transition: background 0.3s;
        }

        /* --- –≠–∫—Ä–∞–Ω—ã --- */
        #auth-screen, #app-screen { height: 100%; width: 100%; position: absolute; }
        .view-section {
            width: 100%; height: 100%; position: absolute; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-dark); display: flex; flex-direction: column;
        }
        #chat-list-view { z-index: 10; }
        #chat-window-view { z-index: 20; transform: translateX(100%); }
        .show-chat #chat-window-view { transform: translateX(0); }

        /* --- –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ --- */
        .header {
            height: 60px; background: var(--bg-panel); display: flex;
            align-items: center; padding: 0 15px; gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 30;
        }
        .btn-circle {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--primary); color: white; display: flex;
            justify-content: center; align-items: center; cursor: pointer;
        }
        .search-input {
            flex: 1; background: rgba(0,0,0,0.1); border: none;
            padding: 10px 15px; border-radius: 20px; color: var(--text-main);
        }

        /* --- –ß–∞—Ç-–ª–∏—Å—Ç --- */
        .chat-item {
            display: flex; align-items: center; padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .chat-item:active { background: rgba(0,0,0,0.1); }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #444; }
        .chat-info { flex: 1; margin-left: 15px; overflow: hidden; }
        .chat-top { display: flex; justify-content: space-between; align-items: center; }
        .last-msg { color: var(--text-muted); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π --- */
        .msgs-container {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            background: url('https://www.transparenttextures.com/patterns/graphy-dark.png');
        }
        .msg {
            max-width: 80%; padding: 10px 14px; border-radius: 15px; font-size: 15px;
            line-height: 1.4; position: relative;
        }
        .msg.mine { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.theirs { align-self: flex-start; background: var(--bg-panel); border-bottom-left-radius: 2px; }

        .input-area {
            padding: 10px; background: var(--bg-panel); display: flex; gap: 10px; align-items: center;
        }

        /* --- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å --- */
        #sidebar {
            position: fixed; left: -280px; top: 0; bottom: 0; width: 280px;
            background: var(--bg-panel); z-index: 100; transition: 0.3s;
            display: flex; flex-direction: column; padding: 20px;
        }
        #sidebar.active { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
        .side-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; z-index: 90; backdrop-filter: blur(2px);
        }

        /* --- –ú–æ–¥–∞–ª–∫–∏ --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; z-index: 200; align-items: flex-end;
        }
        .modal-body {
            width: 100%; background: var(--bg-panel); padding: 20px;
            border-radius: 20px 20px 0 0; animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } }

        .admin-user {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #444;
        }
    </style>
</head>
<body class="dark-theme">

    <div id="auth-screen">
        <div style="padding: 40px; text-align: center;">
            <h1 style="color: var(--primary); font-size: 40px;">BliKins</h1>
            <div id="auth-form">
                <input type="text" id="auth-login" class="search-input" style="width:100%; margin-bottom:10px;" placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="auth-pass" class="search-input" style="width:100%; margin-bottom:10px;" placeholder="–ü–∞—Ä–æ–ª—å">
                <div id="reg-extra" style="display:none;">
                    <input type="password" id="auth-pass2" class="search-input" style="width:100%; margin-bottom:10px;" placeholder="–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è">
                    <input type="text" id="auth-secret" class="search-input" style="width:100%; margin-bottom:10px;" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥">
                </div>
                <button class="btn-circle" style="width:100%; border-radius:10px;" onclick="handleAuth()" id="auth-btn">–í–æ–π—Ç–∏</button>
                <p onclick="toggleAuthMode()" id="auth-toggle" style="color:var(--secondary); cursor:pointer; margin-top:20px;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
            </div>
        </div>
    </div>

    <div id="app-screen" style="display:none;">
        <div class="side-overlay" id="overlay" onclick="closeSidebar()"></div>
        <div id="sidebar">
            <div style="text-align:center; border-bottom: 1px solid #444; padding-bottom:20px; margin-bottom:20px;">
                <label for="ava-upload">
                    <img id="my-avatar" src="" class="avatar" style="width:80px; height:80px; border: 2px solid var(--primary);">
                    <input type="file" id="ava-upload" hidden accept="image/*" onchange="uploadAvatar(this)">
                </label>
                <h3 id="my-name" style="margin:10px 0 5px;">User</h3>
                <div style="color:gold;"><i class="fas fa-coins"></i> <span id="my-coins">0</span> Pepe</div>
            </div>
            <div onclick="openModal('profile-modal')" style="padding:12px; cursor:pointer;"><i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å</div>
            <div onclick="openModal('settings-modal')" style="padding:12px; cursor:pointer;"><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div id="admin-link" onclick="openAdmin()" style="padding:12px; cursor:pointer; display:none; color:var(--accent);"><i class="fas fa-crown"></i> –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</div>
            <div onclick="logout()" style="padding:12px; cursor:pointer; color:var(--danger); margin-top:auto;"><i class="fas fa-sign-out-alt"></i> –í—ã—Ö–æ–¥</div>
        </div>

        <div class="view-section" id="chat-list-view">
            <div class="header">
                <i class="fas fa-bars" onclick="openSidebar()" style="font-size:20px;"></i>
                <input type="text" class="search-input" id="search-q" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π/–∫–∞–Ω–∞–ª–æ–≤..." oninput="doSearch(this.value)">
                <button class="btn-circle" style="width:35px; height:35px;" onclick="openModal('create-modal')"><i class="fas fa-pen"></i></button>
            </div>
            <div id="chats-list" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div class="view-section" id="chat-window-view">
            <div class="header">
                <i class="fas fa-arrow-left" onclick="closeChat()"></i>
                <img id="chat-ava" src="" class="avatar" style="width:40px; height:40px;">
                <div style="flex:1;">
                    <div id="chat-title" style="font-weight:bold;">Name</div>
                    <small id="chat-status" style="color:var(--text-muted);">online</small>
                </div>
            </div>
            <div class="msgs-container" id="msgs-box"></div>
            <div class="input-area" id="msg-controls">
                <input type="text" id="msg-input" class="search-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn-circle" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="modal" id="create-modal" onclick="closeModal('create-modal')">
        <div class="modal-body" onclick="event.stopPropagation()">
            <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ</h3>
            <button class="btn-circle" style="width:100%; border-radius:10px; margin-bottom:10px;" onclick="prepCreate('group')">üë• –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</button>
            <button class="btn-circle" style="width:100%; border-radius:10px; background:var(--secondary);" onclick="prepCreate('channel')">üì¢ –ù–æ–≤—ã–π –∫–∞–Ω–∞–ª</button>
        </div>
    </div>

    <div class="modal" id="admin-modal" onclick="closeModal('admin-modal')">
        <div class="modal-body" style="height: 80vh;" onclick="event.stopPropagation()">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ê–¥–º–∏–Ω)</h3>
            <div id="admin-list" style="height: 90%; overflow-y: auto;"></div>
        </div>
    </div>

    <div class="modal" id="settings-modal" onclick="closeModal('settings-modal')">
        <div class="modal-body" onclick="event.stopPropagation()">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <p>–¢–µ–º–∞:</p>
            <button onclick="setTheme('dark')" class="btn-circle" style="width:100%; border-radius:10px; margin-bottom:5px;">–¢–µ–º–Ω–∞—è</button>
            <button onclick="setTheme('light')" class="btn-circle" style="width:100%; border-radius:10px; background:#ddd; color:#000;">–°–≤–µ—Ç–ª–∞—è</button>
            <p>–Ø–∑—ã–∫:</p>
            <select id="lang-sel" class="search-input" style="width:100%;" onchange="alert('–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω!')">
                <option>–†—É—Å—Å–∫–∏–π</option><option>English</option><option>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option><option>Deutsch</option>
            </select>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, update, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        // –í–∞–∂–Ω–æ: –î–ª—è —Ñ–æ—Ç–æ –Ω—É–∂–µ–Ω Storage
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBV3cEHIGsVyCSeNy1eo4ZBj7vhL0f0nHA",
            authDomain: "blikins-23ca8.firebaseapp.com",
            databaseURL: "https://blikins-23ca8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "blikins-23ca8",
            storageBucket: "blikins-23ca8.firebasestorage.app",
            messagingSenderId: "907805919084",
            appId: "1:907805919084:web:714e2d2b63d738e86c9549"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        let user = null;
        let isReg = false;
        let activeChat = null;

        // --- AUTH ---
        window.toggleAuthMode = () => {
            isReg = !isReg;
            document.getElementById('reg-extra').style.display = isReg ? 'block' : 'none';
            document.getElementById('auth-btn').innerText = isReg ? '–°–æ–∑–¥–∞—Ç—å' : '–í–æ–π—Ç–∏';
            document.getElementById('auth-toggle').innerText = isReg ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏' : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
        };

        window.handleAuth = async () => {
            const login = document.getElementById('auth-login').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value;
            if(!login || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");

            if(isReg) {
                const pass2 = document.getElementById('auth-pass2').value;
                const secret = document.getElementById('auth-secret').value;
                if(pass !== pass2) return alert("–ü–∞—Ä–æ–ª–∏ —Ä–∞–∑–Ω—ã–µ");
                
                let role = 'user';
                if(secret === '232348') role = 'user';
                else if(secret === '*?‚Ññ3827428') role = 'admin';
                else return alert("–ù—É–∂–µ–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥!");

                const exist = await get(ref(db, 'usernames/' + login));
                if(exist.exists()) return alert("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç");

                const uid = 'u_' + Date.now();
                const data = {
                    uid, login, pass, role, name: login, pepeCoins: 0,
                    avatar: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
                    isVerified: (role === 'admin')
                };
                await set(ref(db, 'users/' + uid), data);
                await set(ref(db, 'usernames/' + login), uid);
                // –ë–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                const cid = push(ref(db, 'chats')).key;
                await set(ref(db, `chats/${cid}`), { type:'bot', owner:'system', name:'BliKins Support' });
                await set(ref(db, `users/${uid}/my_chats/${cid}`), true);
                alert("–£—Å–ø–µ—Ö! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏.");
                toggleAuthMode();
            } else {
                const nSnap = await get(ref(db, 'usernames/' + login));
                if(!nSnap.exists()) return alert("–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —é–∑–µ—Ä–∞");
                const uSnap = await get(ref(db, 'users/' + nSnap.val()));
                const d = uSnap.val();
                if(d.pass !== pass) return alert("–ü–∞—Ä–æ–ª—å –Ω–µ —Ç–æ—Ç");
                user = d;
                startApp();
            }
        };

        function startApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            syncProfile();
            loadChats();
        }

        function syncProfile() {
            document.getElementById('my-avatar').src = user.avatar;
            document.getElementById('my-name').innerText = user.name;
            document.getElementById('my-coins').innerText = user.pepeCoins;
            if(user.role === 'admin') document.getElementById('admin-link').style.display = 'block';
        }

        // --- –§–û–¢–û ---
        window.uploadAvatar = async (input) => {
            const file = input.files[0];
            if(!file) return;
            const sPath = sRef(storage, `avatars/${user.uid}`);
            await uploadBytes(sPath, file);
            const url = await getDownloadURL(sPath);
            await update(ref(db, `users/${user.uid}`), { avatar: url });
            user.avatar = url;
            syncProfile();
        };

        // --- –°–û–ó–î–ê–ù–ò–ï –ì–†–£–ü–ü ---
        window.prepCreate = async (type) => {
            const title = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:");
            if(!title) return;
            const cid = push(ref(db, 'chats')).key;
            await set(ref(db, `chats/${cid}`), {
                type, name: title, owner: user.uid,
                avatar: "https://cdn-icons-png.flaticon.com/512/681/681494.png",
                lastMsg: "–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω"
            });
            await set(ref(db, `users/${user.uid}/my_chats/${cid}`), true);
            closeModal('create-modal');
        };

        // --- –ß–ê–¢–´ ---
        function loadChats() {
            onValue(ref(db, `users/${user.uid}/my_chats`), (snap) => {
                const list = document.getElementById('chats-list');
                list.innerHTML = "";
                const data = snap.val() || {};
                Object.keys(data).forEach(async cid => {
                    const cSnap = await get(ref(db, `chats/${cid}`));
                    const c = cSnap.val();
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.innerHTML = `
                        <img src="${c.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="avatar">
                        <div class="chat-info">
                            <div class="chat-top"><b>${c.name || '–ß–∞—Ç'}</b></div>
                            <div class="last-msg">${c.lastMsg || ''}</div>
                        </div>
                    `;
                    item.onclick = () => openChat(cid, c);
                    list.appendChild(item);
                });
            });
        }

        function openChat(id, data) {
            activeChat = { id, ...data };
            document.body.classList.add('show-chat');
            document.getElementById('chat-title').innerText = data.name;
            document.getElementById('chat-ava').src = data.avatar;
            
            // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –∏ —Ç—ã –Ω–µ –∞–¥–º–∏–Ω - —Å–∫—Ä—ã—Ç—å –≤–≤–æ–¥
            const canWrite = (data.type !== 'channel' || data.owner === user.uid);
            document.getElementById('msg-controls').style.display = canWrite ? 'flex' : 'none';

            onValue(ref(db, `messages/${id}`), (snap) => {
                const box = document.getElementById('msgs-box');
                box.innerHTML = "";
                const msgs = snap.val() || {};
                Object.values(msgs).forEach(m => {
                    const d = document.createElement('div');
                    d.className = `msg ${m.uid === user.uid ? 'mine' : 'theirs'}`;
                    d.innerText = m.txt;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendMsg = async () => {
            const inp = document.getElementById('msg-input');
            if(!inp.value || !activeChat) return;
            const m = { txt: inp.value, uid: user.uid, time: Date.now() };
            await push(ref(db, `messages/${activeChat.id}`), m);
            await update(ref(db, `chats/${activeChat.id}`), { lastMsg: inp.value });
            inp.value = "";
        };

        // --- –ê–î–ú–ò–ù–ö–ê ---
        window.openAdmin = async () => {
            openModal('admin-modal');
            const snap = await get(ref(db, 'users'));
            const list = document.getElementById('admin-list');
            list.innerHTML = `<p>–í—Å–µ–≥–æ: ${Object.keys(snap.val()).length}</p>`;
            Object.values(snap.val()).forEach(u => {
                const d = document.createElement('div');
                d.className = 'admin-user';
                d.innerHTML = `
                    <span>${u.login} [${u.pepeCoins}]</span>
                    <div>
                        <button onclick="giveBonus('${u.uid}')">üí∞</button>
                        <button onclick="toggleVerify('${u.uid}')">‚úÖ</button>
                    </div>
                `;
                list.appendChild(d);
            });
        };

        window.giveBonus = async (uid) => {
            const snap = await get(ref(db, `users/${uid}/pepeCoins`));
            await set(ref(db, `users/${uid}/pepeCoins`), (snap.val() || 0) + 100);
            alert("–î–∞–Ω–æ 100 Pepe");
            openAdmin();
        };

        // --- –ü–û–ò–°–ö ---
        window.doSearch = async (q) => {
            if(q.length < 2) return loadChats();
            const snap = await get(ref(db, 'usernames/' + q.toLowerCase()));
            if(snap.exists()) {
                const targetUid = snap.val();
                if(targetUid === user.uid) return;
                const uData = (await get(ref(db, 'users/' + targetUid))).val();
                const list = document.getElementById('chats-list');
                list.innerHTML = `<div class="chat-item" onclick="startPrivate('${targetUid}', '${uData.name}')">
                    <img src="${uData.avatar}" class="avatar">
                    <div class="chat-info"><b>${uData.name}</b><br><small>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å</small></div>
                </div>`;
            }
        };

        window.startPrivate = async (tid, tname) => {
            const cid = user.uid < tid ? user.uid + tid : tid + user.uid;
            await set(ref(db, `chats/${cid}`), { type:'pvp', name: tname, participants: [user.uid, tid] });
            await set(ref(db, `users/${user.uid}/my_chats/${cid}`), true);
            await set(ref(db, `users/${tid}/my_chats/${cid}`), true);
            document.getElementById('search-q').value = "";
            loadChats();
        };

        // UI Helpers
        window.openSidebar = () => { document.getElementById('sidebar').classList.add('active'); document.getElementById('overlay').style.display='block'; };
        window.closeSidebar = () => { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').style.display='none'; };
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.closeChat = () => document.body.classList.remove('show-chat');
        window.setTheme = (t) => document.body.className = t + '-theme';
        window.logout = () => { localStorage.clear(); location.reload(); };

    </script>
</body>
</html>
